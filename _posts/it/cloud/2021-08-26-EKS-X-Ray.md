---
layout: post
title: "AWS X-Ray"
author: "Bys"
category: cloud
date: 2021-08-26 01:00:00
tags: aws eks xray
---

#### X-Ray 설정  
`X-Ray Daemon`

X-Ray를 띄우는 방식은 WorkerNode에 Daemon으로 띄울수도 있고, Pod에 Sidecar Pattern으로 띄울 수도 있다.  
이번에 적용한 것은 Pod에 Sidecar Pattern으로 Container를 하나 더 띄워 진행하는 것으로 하였다.  

아래와 같이 deployment.yaml에 기존 main-api 컨테이너 이외의 Sidecar형식으로 xray-daemon 컨테이너를 적용하였다.  
```yaml
containers:
  - name: xray-daemon
    image: amazon/aws-xray-daemon
    imagePullPolicy: Always
    ports:
      - containerPort: 2000
        name: xray
        protocol: UDP
    resources:
      requests:
        cpu: 50m
        memory: 50Mi
    env:
      - name: AWS_REGION
        value: "ap-northeast-2"
```
<br>

기본적으로 데몬은 0.0.0.0:2000 포트로 Listen을 하고 있으며, Application에서는 AWS SDK를 적용하여 AWSXRayServletFilter를 셋업하면 localhost:2000 포트로 Segment를 전달하게 되어있다.  
Filter로 Segment 생성이 되고, 필요한 부분에 SubSegment.begin(). SubSegment.end()를 사용하면 Tracing이 되는 구조이다.  

<br><br>



#### X-Ray 권한 설정  

```yaml
containers:
  - name: xray-daemon
    image: amazon/aws-xray-daemon
    imagePullPolicy: Always
    ports:
      - containerPort: 2000
        name: xray
        protocol: UDP
    resources:
      requests:
        cpu: 50m
        memory: 50Mi
    env:
      - name: AWS_REGION
        value: "ap-northeast-2"
```