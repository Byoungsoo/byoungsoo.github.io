---
layout: post
title: "AWS CLI"
author: "Bys"
category: command
date: 2022-07-18 01:00:00
tags: aws cli
---

## iam
```bash
aws sts get-caller-identity

# Assume Role
aws sts assume-role --role-arn arn --role-session-name role-session-name --region ap-northeast-2

ASSUME_ROLE_CREDENTIALS=$(aws sts assume-role --role-arn arn --role-session-name role-session-name --region ap-northeast-2)
export AWS_ACCESS_KEY_ID=$(echo $ASSUME_ROLE_CREDENTIALS | jq .Credentials.AccessKeyId | sed 's/"//g')
export AWS_SECRET_ACCESS_KEY=$(echo $ASSUME_ROLE_CREDENTIALS | jq .Credentials.SecretAccessKey | sed 's/"//g')
export AWS_SESSION_TOKEN=$(echo $ASSUME_ROLE_CREDENTIALS | jq .Credentials.SessionToken | sed 's/"//g')
unset AWS_ACCESS_KEY_ID
unset AWS_SECRET_ACCESS_KEY
unset AWS_SESSION_TOKEN

# Apply profile temp
aws sts get-caller-identity --profile bys-admin

# Apply profile
export AWS_PROFILE=shared-admin
unset AWS_PROFILE

# list instance profiles 
aws iam list-instance-profiles

```

## ec2
```bash
# Describe EC2
aws ec2 describe-instances --instance-ids i-0d701ff0b973d86f2
aws ec2 describe-instances --filters Name=instance-id,Values=i-0d701ff0b973d86f2
aws ec2 describe-instances --filters Name=tag:Name,Values=bastion
aws ec2 describe-instances --filters Name=tag:Name,Values=kube-master-node
aws ec2 describe-instances --filters Name=tag:Name,Values=kube-master-node Name=tag:Owner,Values=kyle

# Security Group
aws ec2 describe-security-groups --filters "Name=vpc-id,Values=vpc-082c840d344b7c8fb" --query "SecurityGroups[*].{Name:GroupName,ID:GroupId}"

```

## elb
```bash
# Describe LB
aws elbv2 describe-load-balancers | jq '.LoadBalancers'
aws elbv2 describe-load-balancers | jq -r '.LoadBalancers[].LoadBalancerArn'

# Describe TG
aws elbv2 describe-target-groups

# Delete LB
aws elbv2 delete-load-balancer --load-balancer-arn arn

# Describe Listener
aws elbv2 describe-listeners --load-balancer-arn arn

# Delete Listener
aws elbv2 delete-listener --listener-arn

# Delete TG
aws elbv2 delete-target-group --target-group-arn arn
```

## ecs
```bash
aws ecs list-container-instances --cluster ecs-bys-cluster
aws ecs describe-container-instances --cluster ecs-training-cluster --container-instances container_instance_ID

aws ecs delete-service --force --cluster ecs-traning-cluster --service redis-service 
aws ecs delete-cluster --cluster test

aws ecs list-task-definitions | jq -r '.taskDefinitionArns[]'
aws ecs list-task-definitions --query "taskDefinitionArns[*]" --output text
aws ecs deregister-task-definition --task-definition arn


```

## ecr
```bash
#ECR Login
aws ecr get-login-password --region ap-northeast-2 | docker login --username AWS --password-stdin 558846430793.dkr.ecr.ap-northeast-2.amazonaws.com

aws ecr get-login-password --region ap-northeast-2 | docker login --username AWS --password-stdin "$(aws sts get-caller-identity --query Account --output text).dkr.ecr.ap-northeast-2.amazonaws.com"

AWS_REGION=ap-northeast-2
aws ecr create-repository \
--repository-name web \
--image-scanning-configuration scanOnPush=true \
--region ${AWS_REGION}

aws ecr create-repository \
--repository-name dogs \
--image-scanning-configuration scanOnPush=true \
--region ${AWS_REGION}
```

## cloudformation
```bash
# Stack Create
aws cloudformation create-stack --stack-name eks-lab-test1 --template-body file://01_main_vpc_settings.yml --parameters ParameterKey=KeyName,ParameterValue=bys-console
aws cloudformation create-stack --stack-name profile-cfn-test --template-url https://s3.amazonaws.com/cloudformation-examples/user-guide/cross-stack/SampleNetworkCrossStack.template

aws cloudformation list-stacks
aws cloudformation describe-stacks --stack-name profile-cfn-test
```


```bash
aws cloudformation create-change-set \
--stack-name profile-cfn-test --change-set-name test --template-body file://profile-cfn-test.json \
--parameters ParameterKey=homeIp,ParameterValue=$(curl -s http://checkip.amazonaws.com/)/32




aws cloudformation update-stack \
--stack-name profile-cfn-test --template-body file://profile-cfn-test.json \
--parameters ParameterKey=homeIp,ParameterValue=$(curl -s http://checkip.amazonaws.com/)/32
```

```json
 { 
  "AWSTemplateFormatVersion" : "2010-09-09",
  "Description" : "AWS CloudFormation Sample Template VPC_with_PublicIPs_And_DNS: Sample template that creates a VPC with DNS and public IPs enabled. Note that you are billed for the AWS resources that you use when you create a stack from this template.",

  "Parameters": {
    "homeIp": {
        "Type": "String",
        "Description": "my changing ip"
    }
  },
  "Resources" : {
    "VPC" : {
      "Type" : "AWS::EC2::VPC",
      "Properties" : {
        "EnableDnsSupport" : "true",
        "EnableDnsHostnames" : "true",
        "CidrBlock" : "10.0.0.0/16"
      }
    },
    "PublicSubnet" : {
      "Type" : "AWS::EC2::Subnet",
      "Properties" : {
        "VpcId" : { "Ref" : "VPC" },
        "CidrBlock" : "10.0.0.0/24"
      }
    },
    "InternetGateway" : {
      "Type" : "AWS::EC2::InternetGateway"
    },
    "VPCGatewayAttachment" : {
       "Type" : "AWS::EC2::VPCGatewayAttachment",
       "Properties" : {
         "VpcId" : { "Ref" : "VPC" },
         "InternetGatewayId" : { "Ref" : "InternetGateway" }
       }
    },
    "PublicRouteTable" : {
      "Type" : "AWS::EC2::RouteTable",
      "Properties" : {
        "VpcId" : { "Ref" : "VPC" }
      }
    },
    "PublicRoute" : {
      "Type" : "AWS::EC2::Route",
      "DependsOn" : "VPCGatewayAttachment",
      "Properties" : {
        "RouteTableId" : { "Ref" : "PublicRouteTable" },
        "DestinationCidrBlock" : "0.0.0.0/0",
        "GatewayId" : { "Ref" : "InternetGateway" }
      }
    },
    "PublicSubnetRouteTableAssociation" : {
      "Type" : "AWS::EC2::SubnetRouteTableAssociation",
      "Properties" : {
        "SubnetId" : { "Ref" : "PublicSubnet" },
        "RouteTableId" : { "Ref" : "PublicRouteTable" }
      }
    },
    "PublicSubnetNetworkAclAssociation" : {
      "Type" : "AWS::EC2::SubnetNetworkAclAssociation",
      "Properties" : {
        "SubnetId" : { "Ref" : "PublicSubnet" },
        "NetworkAclId" : { "Fn::GetAtt" : ["VPC", "DefaultNetworkAcl"] }
      }
    },
    "WebServerSecurityGroup" : {
      "Type" : "AWS::EC2::SecurityGroup",
      "Properties" : {
        "GroupDescription" : "Enable HTTP ingress",
        "VpcId" : { "Ref" : "VPC" },
        "SecurityGroupIngress" : [ { 
          "IpProtocol" : "tcp",
          "FromPort" : "80",  
          "ToPort" : "80",
          "CidrIp" : "0.0.0.0/0"
        },
        { 
          "IpProtocol" : "tcp",
          "FromPort" : "22",  
          "ToPort" : "22",
          "CidrIp" : { "Ref" : "homeIp" }
        } ]
      }
    }
  },
  "Outputs" : {
    "VPCId" : {
      "Description" : "VPC ID",
      "Value" :  { "Ref" : "VPC" },
      "Export" : { "Name" : {"Fn::Sub": "${AWS::StackName}-VPCID" }}
    },
    "PublicSubnet" : {
      "Description" : "The subnet ID to use for public web servers",
      "Value" :  { "Ref" : "PublicSubnet" },
      "Export" : { "Name" : {"Fn::Sub": "${AWS::StackName}-SubnetID" }}
    },
    "WebServerSecurityGroup" : {
      "Description" : "The security group ID to use for public web servers",
      "Value" :  { "Fn::GetAtt" : ["WebServerSecurityGroup", "GroupId"] },
      "Export" : { "Name" : {"Fn::Sub": "${AWS::StackName}-SecurityGroupID" }}
    }
  }
}
```