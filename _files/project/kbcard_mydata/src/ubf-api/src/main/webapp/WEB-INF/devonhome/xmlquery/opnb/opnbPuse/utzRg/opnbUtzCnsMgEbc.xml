<?xml version="1.0" encoding="EUC-KR"?>
<statements>

	<!-- 계좌별이용동의 조회 -->
    <statement name="selectAccPrUtzCns">
		<![CDATA[
			SELECT /*+ 정영훈::/opnb/opnbPuse/utzRg/opnbUtzCnsMgEbc/selectAccPrUtzCns */ 
			            계좌조회동의여부
                 , 출금동의여부 
                 , 고객계좌번호
              FROM INSTC.TBUBFS002      /* UBF오픈뱅킹계좌기본 */       
             WHERE 계좌개설은행코드               = ${계좌개설은행코드}
               AND 고객계좌번호                    = ${고객계좌번호}
               AND 오픈뱅킹이용기관코드          = ${오픈뱅킹이용기관코드}
               AND 오픈뱅킹사용자고유번호        = NVL(${오픈뱅킹사용자고유번호},오픈뱅킹사용자고유번호)
               AND ROWNUM = 1
		]]>
    </statement>
    
    <!-- 카드사별이용동의 조회 -->
    <statement name="selectCrdPrUtzCns">
		<![CDATA[
			SELECT /*+ 박건우::/opnb/opnbPuse/utzRg/opnbUtzCnsMgEbc/selectCrdPrUtzCns */ 
			            오픈뱅킹사용자고유번호
                 , 오픈뱅킹회원금융회사코드      
                 , 오픈뱅킹개설기관코드     
                 , 카드정보조회동의여부
              FROM INSTC.TBUBFS005      /* UBF오픈뱅킹카드고객기본 */       
             WHERE 오픈뱅킹사용자고유번호         = ${오픈뱅킹사용자고유번호}
               AND 오픈뱅킹회원금융회사코드       = ${오픈뱅킹회원금융회사코드} 
               AND ROWNUM               = 1
		]]>
    </statement>

    <!-- 오픈뱅킹고객동의이력등록 -->
    <statement name="regOpnbCstCnsPhs">
		<![CDATA[
			INSERT /*+ 김정화::/opnb/opnbPuse/utzRg/opnbUtzCnsMgEbc/regOpnbCstCnsPhs */
	          INTO INSTC.TBUBFS004        /* UBF오픈뱅킹고객동의이력 */
		    	 (
		 	           오픈뱅킹사용자고유번호
                , 오픈뱅킹약관동의일련번호
				, 채널세부업무구분코드
				, 오픈뱅킹약관동의구분코드
				, 오픈뱅킹약관동의일시
				, 오픈뱅킹동의연장구분코드
				, 오픈뱅킹동의자료구분코드
				, 시스템최초생성일시
				, 시스템최초생성식별자
				, 시스템최종갱신일시
				, 시스템최종갱신식별자
				, 시스템최종거래일시
			    )
			     VALUES
			    (
			      ${오픈뱅킹사용자고유번호}      
                , INSTC.SQ_TBUBFS004_01.NEXTVAL
				, ${채널세부업무구분코드}
				, ${오픈뱅킹약관동의구분코드}
				, ${오픈뱅킹약관동의일시}
				, ${오픈뱅킹동의연장구분코드}
				, ${오픈뱅킹동의자료구분코드}
				, SYSTIMESTAMP
				, ${시스템최초생성식별자}
				, SYSTIMESTAMP
				, ${시스템최종갱신식별자}
				, ${시스템최종거래일시}  
			)
		]]>
    </statement>

    <!--  이용동의 조회  -->
    <statement name="selectUtzCns">
		<![CDATA[
			SELECT /*+ 김정화::/opnb/opnbPuse/utzRg/opnbUtzCnsMgEbc/selectUtzCns */ 
			    채널세부업무구분코드 , 
			    NVL(MAX(오픈뱅킹통합계좌조회동의여부),'N')  , 
			    NVL(MAX(계좌조회동의여부),'N') , 
			    NVL(MAX(출금동의여부),'N') , 
			    NVL(MAX(카드정보조회동의여부),'N') 
			  FROM 
			(
			SELECT C.채널세부업무구분코드
			     , A.오픈뱅킹사용자고유번호
			     , B.고객계좌번호
			     , A.오픈뱅킹통합계좌조회동의여부
			     , B.계좌조회동의여부
			     , C.출금동의여부
			     , '' AS 카드정보조회동의여부
			     , null AS 오픈뱅킹카드고객일련번호 
			  FROM INSTC.TBUBFS001 A /* UBF오픈뱅킹고객정보기본 */ 
			     , INSTC.TBUBFS002 B /* UBF오픈뱅킹계좌기본 */ 
			     , INSTC.TBUBFS003 C /* UBF오픈뱅킹계좌상세 */  
			WHERE A.오픈뱅킹사용자고유번호 = B.오픈뱅킹사용자고유번호(+)
			  AND B.고객계좌번호 = C.고객계좌번호(+)
			  AND A.CI내용 = C.CI내용(+)
			  AND A.오픈뱅킹사용자고유번호 = ${오픈뱅킹사용자고유번호}
			UNION ALL
			SELECT E.채널세부업무구분코드
			     , A.오픈뱅킹사용자고유번호
			     , '' AS 고객계좌번호
			     , A.오픈뱅킹통합계좌조회동의여부
			     , '' AS 계좌조회동의여부
			     , '' AS 출금동의여부
			     , E.카드정보조회동의여부
			     , D.오픈뱅킹카드고객일련번호 
			  FROM INSTC.TBUBFS001 A /* UBF오픈뱅킹고객정보기본 */
			     , INSTC.TBUBFS005 D /* UBF오픈뱅킹카드고객기본 */
			     , INSTC.TBUBFS006 E /* UBF오픈뱅킹카드고객상세 */    
			WHERE A.오픈뱅킹사용자고유번호 = D.오픈뱅킹사용자고유번호(+)
			  AND D.오픈뱅킹회원금융회사코드 = E.오픈뱅킹회원금융회사코드(+)
			  AND A.CI내용 = E.CI내용(+)
			  AND A.오픈뱅킹사용자고유번호 = ${오픈뱅킹사용자고유번호}
			)
			WHERE 채널세부업무구분코드 IS NOT NULL
			GROUP BY 채널세부업무구분코드, 오픈뱅킹사용자고유번호
		]]>
    </statement>

    <!-- 오픈뱅킹계좌기본동의갱신 -->
    <statement name="uptOpnbAccBasCns">
		<![CDATA[
			UPDATE /*+ 김정화::/opnb/opnbPuse/utzRg/opnbUtzCnsMgEbc/uptOpnbAccBasCns */ 
                   INSTC.TBUBFS002        /* UBF오픈뱅킹계좌기본 */
               SET 계좌조회동의갱신일시 = ${동의일시}
				 , 조회갱신채널세부업무구분코드 = ${채널세부업무구분코드}
				 , 출금동의갱신일시 = ${동의일시} 
				 , 출금갱신채널세부업무구분코드 = ${채널세부업무구분코드}
                 , 시스템최종갱신일시              = SYSTIMESTAMP         
                 , 시스템최종갱신식별자            = ${시스템최종갱신식별자}        
                 , 시스템최종거래일시              =  ${시스템최종거래일시}        
             WHERE 오픈뱅킹사용자고유번호         = ${오픈뱅킹사용자고유번호}
		]]>
    </statement>
    
	<!-- 오픈뱅킹계좌상세동의갱신 -->
    <statement name="uptOpnbAccDtlCns">
		<![CDATA[
			UPDATE /*+ 김정화::/opnb/opnbPuse/utzRg/opnbUtzCnsMgEbc/uptOpnbAccDtlCns */ 
                   INSTC.TBUBFS003        /* UBF오픈뱅킹계좌상세 */
               SET 출금동의갱신일시           	 = ${동의일시}      
                 , 시스템최종갱신일시              = SYSTIMESTAMP          
                 , 시스템최종갱신식별자            = ${시스템최종갱신식별자}        
                 , 시스템최종거래일시              =  ${시스템최종거래일시}         
             WHERE CI내용 	          = (SELECT CI내용 FROM INSTC.TBUBFS001 WHERE 오픈뱅킹사용자고유번호 = ${오픈뱅킹사용자고유번호})
            	 AND 채널세부업무구분코드            = ${채널세부업무구분코드}
		]]>
    </statement>
    
     <!-- 오픈뱅킹카드고객기본동의갱신 -->
    <statement name="uptOpnbCrdCstBasCns">
		<![CDATA[
			UPDATE /*+ 김정화::/opnb/opnbPuse/utzRg/opnbUtzCnsMgEbc/uptOpnbCrdCstBasCns */ 
                   INSTC.TBUBFS005        /* UBF오픈뱅킹카드고객기본 */
               SET 카드정보조회동의갱신일시 = ${동의일시}
				 , 조회갱신채널세부업무구분코드 = ${채널세부업무구분코드}
                 , 시스템최종갱신일시              = SYSTIMESTAMP         
                 , 시스템최종갱신식별자            = ${시스템최종갱신식별자}        
                 , 시스템최종거래일시              = ${시스템최종거래일시}  
             WHERE 오픈뱅킹사용자고유번호         = ${오픈뱅킹사용자고유번호}
		]]>
    </statement>
    
	<!-- 오픈뱅킹카드고객상세동의갱신 -->
    <statement name="uptOpnbCrdCstDtlCns">
		<![CDATA[
			UPDATE /*+ 김정화::/opnb/opnbPuse/utzRg/opnbUtzCnsMgEbc/uptOpnbCrdCstDtlCns */ 
                   INSTC.TBUBFS006        /* UBF오픈뱅킹카드고객상세 */
               SET 카드정보조회동의갱신일시      = ${동의일시}      
                 , 시스템최종갱신일시              = SYSTIMESTAMP          
                 , 시스템최종갱신식별자            = ${시스템최종갱신식별자}        
                 , 시스템최종거래일시              =  ${시스템최종거래일시}          
             WHERE CI내용 	          = (SELECT CI내용 FROM INSTC.TBUBFS001 WHERE 오픈뱅킹사용자고유번호 = ${오픈뱅킹사용자고유번호})
            	 AND 채널세부업무구분코드            = ${채널세부업무구분코드}
		]]>
    </statement>
    
    
    <!-- 고객동의이력 목록 조회 -->
    <statement name="selectCstCnsHisCtg">
		<![CDATA[
			SELECT /*+ 김정화::/opnb/opnbPuse/utzRg/opnbUtzCnsMgEbc/selectCstCnsHisCtg */ 
			         채널세부업무구분코드 
			    , 오픈뱅킹약관동의일시
			    , 오픈뱅킹약관동의구분코드 
		        , 오픈뱅킹동의연장구분코드 
		        , 오픈뱅킹동의자료구분코드
              FROM INSTC.TBUBFS004      /* UBF오픈뱅킹고객동의이력 */       
             WHERE 오픈뱅킹사용자고유번호        = ${오픈뱅킹사용자고유번호}
           		AND 채널세부업무구분코드 = ${채널세부업무구분코드}
		]]>
    </statement>
    
    <!-- 오픈뱅킹최초등록일시 조회 -->
    <statement name="selectOpnbFstRgYms">
		<![CDATA[
			SELECT /*+ 김정화::/opnb/opnbPuse/utzRg/opnbUtzCnsMgEbc/selectOpnbFstRgYms */ 
			        MIN(오픈뱅킹약관동의일시) AS 오픈뱅킹최초등록일시
              FROM INSTC.TBUBFS004      /* UBF오픈뱅킹고객동의이력 */       
             WHERE 오픈뱅킹사용자고유번호        = ${오픈뱅킹사용자고유번호}
           		AND 오픈뱅킹약관동의구분코드 = 1
		]]>
    </statement>
    
    <!-- 오픈뱅킹최종사용일시 조회 -->
    <statement name="selectOpnbLstUseYms">
		<![CDATA[
			SELECT /*+ 김정화::/opnb/opnbPuse/utzRg/opnbUtzCnsMgEbc/selectOpnbLstUseYms */ 
			       TO_CHAR(MAX(시스템최종갱신일시), 'YYYYMMDDHH24MISS')  AS 오픈뱅킹최종사용일시
              FROM INSTC.TBUBFS008      /* UBF오픈뱅킹기관거래내역 */       
             WHERE 오픈뱅킹사용자고유번호        = ${오픈뱅킹사용자고유번호}
		]]>
    </statement>
      
    <!-- 오픈뱅킹이용동의최종갱신일시 조회 -->
    <statement name="selectOpnbUtzCnsLstUpdYms">
		<![CDATA[
			SELECT /*+ 김정화::/opnb/opnbPuse/utzRg/opnbUtzCnsMgEbc/selectOpnbUtzCnsLstUpdYms */ 
			       MAX(오픈뱅킹약관동의일시) AS 오픈뱅킹이용동의최종갱신일시
              FROM INSTC.TBUBFS004      /* UBF오픈뱅킹고객동의이력 */       
             WHERE 오픈뱅킹사용자고유번호        = ${오픈뱅킹사용자고유번호}
           		AND 오픈뱅킹약관동의구분코드 = 2
		]]>
    </statement>
</statements>
