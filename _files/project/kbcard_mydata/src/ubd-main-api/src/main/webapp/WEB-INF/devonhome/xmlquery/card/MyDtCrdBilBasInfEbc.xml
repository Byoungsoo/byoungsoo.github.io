<?xml version="1.0" encoding="UTF-8"?>
<statements>

    <statement name="selectMyDtApiCrdBilBasInf">
		<![CDATA[
		SELECT /*+ 임용택::/card/MyDtCrdBilBasInfEbc/selectMyDtApiCrdBilBasInf */
			   A.회원일련번호
		     , A.고객식별자
		     , A.고객관리번호
		     , A.청구일련번호
		     , A.결제년월일
		     , SUBSTR(A.결제년월일,7,2) AS 결제일
		     , SUBSTR(A.결제년월일,0,6) AS 결제년월
		     , A.고객명
		     , A.순청구합계금액 AS 청구금액
		FROM INSTC.TBUBDG001 A  /* GBC이용대금명세서기본(TBGBCB001) */
		   , ( SELECT *
		        FROM INSTC.TBUBDO001 /* GAC회원기본(TBGACHW01) */
		       WHERE 고객식별자     = ${고객식별자}
		         AND 고객관리번호   = ${고객관리번호}
		     ) B
		WHERE A.회원일련번호   = B.회원일련번호
		  AND A.결제년월일    >= ${조회시작년월}||'01'
		  AND A.결제년월일    <= ${조회종료년월}||'31'
		  AND A.순청구합계금액 <> 0
		]]>
    </statement>

    <statement name="selectMyDtApiCrdBilDtlInf">
		<![CDATA[
		SELECT /*+ 임용택::/card/MyDtCrdBilBasInfEbc/selectMyDtApiCrdBilDtlInf */
			   Z.테이블구분_V4
			 , Z.카드대체번호
		     , Z.회원일련번호
		     , Z.고객식별자 
		     , Z.고객관리번호
		     , Z.청구일련번호
		     , Z.결제년월일
		     , Z.명세서상세일련번호
		     , Z.카드사용년월일
		     , CASE WHEN Z.명세서전표분류구분코드 IN ('01','02','03','04','06') THEN Z.명세서전표분류구분코드
		            WHEN Z.명세서전표분류구분코드 = '05' THEN '04' -- 리볼빙 현금서비스
		            ELSE '99' END AS 명세서전표분류구분코드
		     , Z.가맹점명
		     , Z.가맹점소재지도시명
		     , Z.매출금액
		     , Z.해외이용청구금액
		     , Z.명세서현지이용금액
		     , Z.청구회차
		     , Z.청구원금
		     , Z.청구수수료 + Y.무이자수수료_N13 AS 청구수수료
		     , Z.청구잔여회차
		     , Z.분할전표청구후잔액
		     , Z.할부개월수
		     , Z.가맹점번호
		     , Z.회원순차일련번호
		     , Z.매출전표번호
		     , Z.적립예정포인트점수
		     , Z.포인트리가맹점구분코드
		     , Z.사업자등록번호
		     , Z.카드식별자
		     , Z.카드서비스유형구분코드
		     , Z.할인서비스코드
		     , Z.매출할인여부
		     , Y.무이자수수료_N13
		     , 'KRW' AS 통화코드
		FROM ( 
			  SELECT '010' AS 테이블구분_V4 
		           , A.회원일련번호
		           , C.고객식별자 
		           , C.고객관리번호
		           , A.청구일련번호
		           , A.결제년월일
		           , A.명세서상세일련번호
		           , A.kb카드bc카드구분코드
		           , A.카드브랜드구분코드
		           , A.명세서전표분류구분코드
		           , A.카드번호뒤4자리번호
		           , A.카드사용년월일
		           , A.해외이용여부
		           , A.가맹점명
		           , A.가맹점소재지도시명
		           , A.매출금액
		           , A.해외이용청구금액
		           , A.명세서현지이용금액
		           , A.청구회차
		           , A.청구원금
		           , A.청구수수료
		           , A.청구잔여회차
		           , A.분할전표청구후잔액
		           , A.실제소유자고객명
		           , A.명세서추가정보구분코드
		           , A.할부개월수
		           , A.가맹점번호
		           , A.회원순차일련번호
		           , A.매출전표번호
		           , A.적립예정포인트점수
		           , A.포인트리가맹점구분코드
		           , A.pg전표구분코드
		           , A.사업자등록번호
		           , A.카드식별자
		           , A.카드서비스유형구분코드
		           , A.할인서비스코드
		           , A.매출할인여부
		           , X.카드대체번호
		           , A.명세서상세일련번호+1   AS 명세서상세일련번호2
		           , ROW_NUMBER() OVER (PARTITION BY A.결제년월일, A.명세서상세일련번호
		                                    ORDER BY X.카드상세일련번호)                    AS RANKING
		        FROM INSTC.TBUBDG002 A /* GBC이용대금명세서카드내역(TBGBCB010) */
		           , INSTC.TBUBDE005 X /* GAG대체카드상세(TBGAGCD20) */
		           , INSTC.TBUBDO001 C /* GAC회원기본(TBGACHW01) */
		           
		       WHERE C.고객식별자        = ${고객식별자}
		         AND C.고객관리번호      = ${고객관리번호}
		         AND A.회원일련번호      = C.회원일련번호
		         AND A.회원순차일련번호 IN ('1','7777', '8888', '9999')
		         AND A.청구원금          <> 0 
		         AND A.결제년월일        > ${결제년월}||'01'
		         AND A.결제년월일        < ${결제년월}||'31'
		         AND A.청구일련번호      = ${청구일련번호}           
		         AND A.회원일련번호      = X.회원일련번호(+)
		         AND A.카드식별자        = X.카드식별자(+)
		           
		    UNION ALL
 
			SELECT 'X10' AS 테이블구분_V4
	             , A.회원일련번호
	             , C.고객식별자 
		         , C.고객관리번호
	             , A.청구일련번호
	             , A.결제년월일
	             , A.명세서상세일련번호
	             , A.kb카드bc카드구분코드
	             , A.카드브랜드구분코드
	             , A.명세서전표분류구분코드
	             , A.카드번호뒤4자리번호
	             , A.카드사용년월일
	             , A.해외이용여부
	             , A.가맹점명
	             , A.가맹점소재지도시명
	             , A.매출금액
	             , A.해외이용청구금액
	             , A.명세서현지이용금액
	             , A.청구회차
	             , A.청구원금
	             , A.청구수수료
	             , A.청구잔여회차
	             , A.분할전표청구후잔액
	             , A.실제소유자고객명
	             , A.명세서추가정보구분코드
	             , A.할부개월수
	             , A.가맹점번호
	             , A.회원순차일련번호
	             , A.매출전표번호
	             , A.적립예정포인트점수
	             , A.포인트리가맹점구분코드
	             , A.pg전표구분코드
	             , A.사업자등록번호
	             , A.카드식별자
	             , A.카드서비스유형구분코드
	             , A.할인서비스코드
	             , A.매출할인여부
	             , X.카드대체번호
	             , A.명세서상세일련번호+1   AS 명세서상세일련번호2
	             , ROW_NUMBER() OVER (PARTITION BY A.결제년월일, A.명세서상세일련번호
	                                      ORDER BY X.카드상세일련번호)                    AS RANKING
	          FROM INSTC.TBUBDG010 A /* GBC이용대금명세서카드내역백업(TBGBCBX10) (TBGBCB010 데이터 보관주기 끝난 내역 백업) */
	          	 , INSTC.TBUBDE005 X /* GAG대체카드상세(TBGAGCD20) */
		         , INSTC.TBUBDO001 C /* GAC회원기본(TBGACHW01) */
	         WHERE C.고객식별자             = ${고객식별자}
	           AND C.고객관리번호           = ${고객관리번호}
	           AND A.회원일련번호           = C.회원일련번호
	           AND A.회원순차일련번호       = '1'             /* 카드내역만 보여줌, 합계X */
	           AND A.명세서추가정보구분코드 IN ('01','15')     /* 01:일반매출 15:SMS */
	           AND A.청구원금               <> 0
		       AND A.결제년월일        		> ${결제년월}||'01'
		       AND A.결제년월일        		< ${결제년월}||'31'
	           AND A.청구일련번호           = ${청구일련번호}                                         
	           AND A.회원일련번호           = X.회원일련번호(+)
	           AND A.카드식별자             = X.카드식별자(+)
		  ) Z
		, (
		      SELECT B.회원일련번호
		           , B.청구일련번호
		           , B.결제년월일
		           , B.카드식별자
		           , B.명세서상세일련번호
		           , B.청구수수료  AS 무이자수수료_N13 
		        FROM INSTC.TBUBDG002 B /* GBC이용대금명세서카드내역(TBGBCB010) */
		           , INSTC.TBUBDO001 C /* GAC회원기본(TBGACHW01) */
		       WHERE C.고객식별자             = ${고객식별자}
		         AND C.고객관리번호           = ${고객관리번호}
		         AND B.회원일련번호           = C.회원일련번호
		         AND B.명세서추가정보구분코드 = '03'                /* 03:할부무이자     */
		         AND B.카드서비스유형구분코드 = '14'                /* 14:무이자혜택금액 */
		         AND B.청구일련번호           = ${청구일련번호}
		         AND B.결제년월일             > ${결제년월}||'01'
		         AND B.결제년월일             < ${결제년월}||'31'
		         
		      UNION ALL
		      
		      SELECT B.회원일련번호
		           , B.청구일련번호
		           , B.결제년월일
		           , B.카드식별자
		           , B.명세서상세일련번호
		           , B.청구수수료  AS 무이자수수료_N13 
		        FROM INSTC.TBUBDG010 B /* GBC이용대금명세서카드내역백업(TBGBCBX10) (TBGBCB010 데이터 보관주기 끝난 내역 백업) */
		           , INSTC.TBUBDO001 C /* GAC회원기본(TBGACHW01) */
		       WHERE C.고객식별자             = ${고객식별자}
		         AND C.고객관리번호           = ${고객관리번호}
		         AND B.회원일련번호           = C.회원일련번호
		         AND B.명세서추가정보구분코드 = '03'                /* 03:할부무이자     */
		         AND B.카드서비스유형구분코드 = '14'                /* 14:무이자혜택금액 */
		         AND B.청구일련번호           = ${청구일련번호}
		         AND B.결제년월일             > ${결제년월}||'01'
		         AND B.결제년월일             < ${결제년월}||'31'    
		   ) Y /* 무이자할인 수수료 확인용 */
		WHERE Z.RANKING  = 1
		  AND Z.회원일련번호        = Y.회원일련번호(+)
		  AND Z.청구일련번호        = Y.청구일련번호(+)
		  AND Z.결제년월일          = Y.결제년월일(+)
		  AND Z.명세서상세일련번호2 = Y.명세서상세일련번호(+)
		  AND Z.카드대체번호        IS NOT NULL
		]]>
    </statement>
    
</statements>
